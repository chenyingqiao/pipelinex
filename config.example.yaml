Version: "1.0"
Name: my-pipeline

Metadate:
  type: in-config
  data:
    key1: value1
    key2: value2

AI:
  # 核心：一句话描述意图，用于理解上下文
  intent: "Go 微服务构建并部署到 K8s，包含测试"
  
  # 核心：关键约束，用于验证和修复
  constraints:
    - "多阶段构建"
    - "非 root 用户运行"
    - "必须通过单元测试"
  
  # 核心：模板标识，用于推荐和复用，作为一个标准参照
  template: "go-microservice"
  
  # 核心：生成信息，用于追踪
  generatedAt: "2024-01-15T10:30:00Z"
  version: 1

Param:
  buildId: "2323"
  namespace: "production"
  registry: "myregistry.com"

# 全局执行器定义
Executors:
  local:
    type: local
    config:
      shell: bash
      workdir: /tmp/pipeline
  
  docker:
    type: docker
    config:
      registry: ${Param.registry}
      network: host
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
  
  k8s:
    type: k8s
    config:
      namespace: default
      resources:
        cpu: "1000m"
        memory: "2Gi"

# 日志推送配置
Logging:
  endpoint: http://log-center/api/v1/logs    # 日志后端接口
  headers:
    Authorization: Bearer xxxxxxxxx  # 可选认证
  timeout: 5s
  retry: 3

# 执行图
Graph: |
  stateDiagram-v2
    direction LR
    [*] --> Merge
    Merge --> Build
    Build --> Deploy
    Deploy --> [*]

# 运行时状态
Status:
  Merge: Finished
  Build: Running
  Deploy: Pending

# 节点配置
Nodes:
  Merge:
    executor: local      # 引用全局 Executors.local
    steps:
      - name: checkout
        run: git checkout ${Param.branch}
      - name: merge
        run: git merge origin/release
  
  Build:
    executor: docker     # 引用全局 Executors.docker
    image: golang:1.21-alpine
    steps:
      - name: build
        run: go build -o app .
      - name: image
        run: docker build -t app:${Param.buildId} .
  
  Deploy:
    executor: k8s        # 引用全局 Executors.k8s
    image: bitnami/kubectl:latest
    steps:
      - name: apply
        run: kubectl apply -f ./k8s/
