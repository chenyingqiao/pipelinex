Version: "1.0"
Name: my-pipeline

Param:
  buildId: "2323"
  namespace: "production"
  registry: "myregistry.com"

# 全局执行器定义
Executors:
  local:
    type: local
    config:
      shell: bash
      workdir: /tmp/pipeline
  
  docker:
    type: docker
    config:
      registry: ${Param.registry}
      network: host
      volumes:
        - /var/run/docker.sock:/var/run/docker.sock
  
  k8s:
    type: k8s
    config:
      namespace: default
      resources:
        cpu: "1000m"
        memory: "2Gi"

# 日志推送配置
Logging:
  endpoint: http://log-center/api/v1/logs    # 日志后端接口
  headers:
    Authorization: Bearer xxxxxxxxx  # 可选认证
  timeout: 5s
  retry: 3

# 执行图
Graph: |
  stateDiagram-v2
    direction LR
    [*] --> Merge
    Merge --> Build
    Build --> Deploy
    Deploy --> [*]

# 运行时状态
Status:
  Merge: Finished
  Build: Running
  Deploy: Pending

# 节点配置
Nodes:
  Merge:
    executor: local      # 引用全局 Executors.local
    steps:
      - name: checkout
        run: git checkout ${Param.branch}
      - name: merge
        run: git merge origin/release
  
  Build:
    executor: docker     # 引用全局 Executors.docker
    image: golang:1.21-alpine
    steps:
      - name: build
        run: go build -o app .
      - name: image
        run: docker build -t app:${Param.buildId} .
  
  Deploy:
    executor: k8s        # 引用全局 Executors.k8s
    image: bitnami/kubectl:latest
    steps:
      - name: apply
        run: kubectl apply -f ./k8s/
